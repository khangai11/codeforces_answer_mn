Эхлээд $dp[k]=$ үүсэж болох $k$ урттай ялгаатай дарааллын тоо гэсэн dp сонирхъё. $f(l,r)$-г бүх $m$ нөхцөлийг хангах байдлаар $l$-ээс $r$ хүртэл индексүүд дээр орж болох $[1,2,...,r-l+1]$ дараалллын "cyclic shift"-ийн тоо гэе. Үүнийг $O(m)$ хугацаанд олж чадна. $dp[i]=\sum^{i-1}_{j=0}dp[j]*f(j+1,i)$ гээд болчих юм шиг боловч зарим дарааллыг үүсгэх 1-ээс олон ялгаатай үйлдлийн дараалал байх учир илүү тоололт хийгдэнэ. Жишээ нь, 
* $[3,4,5,1,2,1,2,3,4,5,1,2,3]=[3,4,5,1,2]+[1,2,3,4,5]+[1,2,3]$
* $[3,4,5,1,2,1,2,3,4,5,1,2,3]=[3,4,5,1,2]+[1,2,3]+[4,5,1,2,3]$

Энд эхний үйлдэл нэг янз байх боловч дараагийн 2 үйлдлүүдийг 2 янзаар хийж болж байна. Үнэндээ эхлэл нь 1-ээс ялгаатай бол тэр үйлдэл 1 янз л байх ёстой ба хэрэв 1 бол олон байж болно. Үүнийг шийдэхийн тулд дээрх жишээний 2 дахь байдлаар үйлдэл хийхээс зайлсхийж оронд нь зөвхөн 1 дэх байдлаар хийе. Тухайлбал, $[1,2,...,k]$ дарааллын араас $k+1$-ээр эхэлсэн дараалал нэмэхгүй байхад болно.

$dp[k][l]=(l=0$ бол сүүлд нэмсэн дараалал 1-ээр эхлээгүй байх, $l \ne 0$ бол сүүлд $[1,2,...,l]$-г нэмсэн байх)-аар үүсгэж болох $k$ урттай ялгаатай дарааллын тоо гэсэн dp-ээр $O(n^2m)$ хугацаанд бодож чадна.

[Submission](https://codeforces.com/contest/2124/submission/327791646)